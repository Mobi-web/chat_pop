<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Групповой Чат</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            background: #f0f0f0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: #333;
        }
        #auth {
            background: white;
            padding: 20px;
            margin: 20px auto;
            max-width: 400px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        #chat {
            display: none;
            flex: 1;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        #syncArea {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            background: #f9f9f9;
        }
        #syncArea textarea {
            width: 100%;
            height: 60px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f9f9f9;
        }
        .message {
            margin: 8px 0;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
            background: #e0e0e0;
        }
        .message.sent {
            background: #4caf50;
            color: white;
            margin-left: auto;
            margin-right: 10px;
        }
        .message-header {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        .time {
            font-size: 0.75em;
            color: #666;
            margin-top: 5px;
            display: block;
        }
        #inputArea {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ddd;
            background: white;
        }
        #messageInput {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            margin-right: 10px;
        }
        button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover {
            background: #45a049;
        }
        .instructions {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 15px;
        }
        @media (max-width: 768px) {
            #messages {
                height: calc(100vh - 200px);
            }
        }
    </style>
</head>
<body>
    <div id="auth">
        <div class="instructions">
            <p>1. Введите ник и пароль для входа в чат.</p>
            <p>2. Отправляйте сообщения в общий чат, они сохраняются в вашем браузере.</p>
            <p>3. Для синхронизации скопируйте JSON и поделитесь с другими.</p>
        </div>
        <h2>Вход</h2>
        <input type="text" id="loginNickname" placeholder="Ник (например, alice)" required>
        <input type="password" id="loginPassword" placeholder="Пароль" required>
        <button onclick="login()">Войти</button>
    </div>

    <div id="chat">
        <div id="syncArea">
            <textarea id="syncJson" placeholder="Вставьте JSON для синхронизации или скопируйте отсюда"></textarea>
            <button onclick="syncFromJson()">Синхронизировать из JSON</button>
            <button onclick="copyJson()">Скопировать JSON</button>
        </div>
        <div id="messages"></div>
        <div id="inputArea">
            <input type="text" id="messageInput" placeholder="Введите сообщение...">
            <button onclick="sendMessage()">Отправить</button>
        </div>
    </div>

    <script>
        let currentUser = null;
        let data = {
            users: {}, // { nickname: password }
            messages: [] // [{ sender, text, timestamp }]
        };

        // Загрузка начальных данных из LocalStorage или chat_data.json
        function loadInitialData() {
            const storedData = localStorage.getItem('chat_data');
            if (storedData) {
                try {
                    data = JSON.parse(storedData);
                } catch (err) {
                    console.error('Ошибка загрузки LocalStorage:', err);
                }
            }
            // Загрузка начального chat_data.json из репозитория (если есть)
            fetch('chat_data.json')
                .then(response => response.ok ? response.json() : Promise.reject())
                .then(json => {
                    data.users = { ...data.users, ...json.users };
                    data.messages = [...data.messages, ...json.messages];
                    saveData();
                    if (currentUser) loadMessages();
                })
                .catch(() => console.log('chat_data.json не найден или пустой'));
        }

        // Сохранение данных в LocalStorage
        function saveData() {
            localStorage.setItem('chat_data', JSON.stringify(data, null, 2));
            document.getElementById('syncJson').value = JSON.stringify(data, null, 2);
        }

        // Копирование JSON в буфер обмена
        function copyJson() {
            const json = document.getElementById('syncJson').value;
            navigator.clipboard.writeText(json).then(() => {
                alert('JSON скопирован! Отправьте его другим для синхронизации.');
            });
        }

        // Синхронизация из вставленного JSON
        function syncFromJson() {
            const json = document.getElementById('syncJson').value;
            try {
                const newData = JSON.parse(json);
                if (!newData.users || !newData.messages) throw new Error('Неверный формат JSON');
                data.users = { ...data.users, ...newData.users };
                data.messages = [...new Set([...data.messages, ...newData.messages].map(JSON.stringify))].map(JSON.parse);
                saveData();
                if (currentUser) loadMessages();
                alert('Данные синхронизированы!');
            } catch (err) {
                alert('Ошибка при синхронизации: ' + err.message);
            }
        }

        // Вход (регистрация автоматическая)
        function login() {
            const nickname = document.getElementById('loginNickname').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!nickname || !password) return alert('Заполните все поля');

            if (!data.users[nickname]) {
                data.users[nickname] = password;
                alert('Пользователь создан!');
            } else if (data.users[nickname] !== password) {
                return alert('Неверный пароль');
            }

            currentUser = nickname;
            document.getElementById('auth').style.display = 'none';
            document.getElementById('chat').style.display = 'flex';
            loadMessages();
            saveData();
            alert('Вход успешен! Отправляйте сообщения в общий чат.');
        }

        // Загрузка сообщений
        function loadMessages() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = data.messages
                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
                .map(msg => {
                    const isSent = msg.sender === currentUser;
                    return `<div class="message ${isSent ? 'sent' : ''}">
                        <div class="message-header">${msg.sender}</div>
                        <span>${msg.text}</span>
                        <div class="time">${new Date(msg.timestamp).toLocaleString('ru-RU')}</div>
                    </div>`;
                }).join('');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Отправка сообщения
        function sendMessage() {
            const text = document.getElementById('messageInput').value.trim();
            if (!currentUser) return alert('Войдите в аккаунт');
            if (!text) return alert('Введите сообщение');

            data.messages.push({
                sender: currentUser,
                text,
                timestamp: new Date().toISOString()
            });
            document.getElementById('messageInput').value = '';
            loadMessages();
            saveData();
        }

        // Обработчики событий
        document.getElementById('messageInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') sendMessage();
        });

        // Инициализация
        loadInitialData();
    </script>
</body>
</html>
